# Harness Document Controls
# ===========================
# This file defines integrity rules for all Harness files.
# The validation script reads this config - it is the source of truth.
#
# Rule Types:
#   append_only  - Can add content, cannot delete (status prefixes allowed)
#   immutable    - Cannot change at all once created
#   protected    - Must exist, free to edit content
#   free         - No constraints
#
# See Decision #16 in decision-log.md for integrity rules.
# See Decision #18 in decision-log.md for metadata requirements.

version: 1

# Valid status prefixes that allow "removal" (actually status change)
status_prefixes:
  - "DONE:"
  - "OBSOLETE:"
  - "PARKED:"
  - "ANSWERED:"
  - "PROMOTED:"
  - "ABANDONED:"
  - "MERGED:"

# ============================================
# APPEND-ONLY FILES
# Content matching pattern cannot be deleted
# ============================================
append_only:

  # --- State Files ---
  .harness/project-state.yaml:
    description: "Project state and task tracking"
    sections:
      next_session_actions:
        pattern: '"P[0-2]:'
        description: "Task items - mark DONE/OBSOLETE, never delete"
      sessions:
        pattern: 'session_\d+:'
        description: "Session history is permanent record"

  # --- Governance ---
  .harness/decision-log.md:
    description: "Architectural and process decisions"
    pattern: '^## Decision #\d+'
    note: "Decisions are permanent. Add new decisions, never remove old ones."

  .harness/lessons-learned.md:
    description: "Failures and learnings from experience"
    pattern: '^## Lesson #\d+'
    note: "Lessons are permanent. We learn from history."

  # --- Knowledge ---
  .harness/ideas.yaml:
    description: "Captured ideas with lifecycle"
    pattern: '^  [a-z][a-z0-9_]*:$'
    note: "Ideas can be PROMOTED, ABANDONED, MERGED - never deleted"

  .harness/questions.yaml:
    description: "Open questions awaiting exploration"
    pattern: '^  Q\d+:'
    note: "Questions can be ANSWERED, PARKED - never deleted"

  .harness/patterns-and-ideas.md:
    description: "Patterns discovered during development"
    pattern: '^## '
    note: "Patterns are knowledge. Add new ones, don't remove."

  # --- Taxonomy (structure can evolve but not lose types) ---
  .harness/taxonomy.yaml:
    description: "Classification types for knowledge atoms"
    pattern: '^    - '
    note: "Types can be added, existing types shouldn't be removed"

# ============================================
# IMMUTABLE FILES
# Cannot be modified once created
# ============================================
immutable:

  .harness/atoms.jsonl:
    description: "Knowledge atoms extracted from sessions"
    note: "Atoms are immutable facts. Append new atoms, never modify existing."

  .harness/emergency-captures/*:
    description: "Emergency data captures"
    note: "Historical record of emergency saves"

# ============================================
# PROTECTED FILES
# Must exist, content is editable
# ============================================
protected:
  # Core state
  - .harness/project-state.yaml
  - .harness/decision-log.md
  - .harness/lessons-learned.md
  - .harness/PROJECT-MAP.md

  # Governance
  - 00-governance/capture-protocol.md
  - 00-governance/working-agreement.md
  - 00-governance/document-index.md

  # Root
  - CLAUDE.md

  # This file (self-referential integrity)
  - .harness/document-controls.yaml

# ============================================
# FREE FILES
# No constraints - can be freely edited/deleted
# ============================================
free:
  # Transcripts are auto-generated, can be regenerated
  - .harness/transcripts/*

  # Scripts are code, normal development rules apply
  - .harness/scripts/*

  # Hooks are code
  - .harness/hooks/*

  # Templates are starting points
  - .harness/templates/*

  # Reference material
  - .harness/reference/*

  # Documentation
  - .harness/docs/*

  # Journal entries (personal narrative)
  - .harness/journal/*

  # Context anchors (can evolve)
  - .harness/context-anchors.yaml

  # Project config (settings, not data)
  - .harness/project.yaml

  # Skills (code/prompts, normal development)
  - .claude/skills/*
  - .claude/commands/*

# ============================================
# CONTENT LOCATIONS (D17)
# Where each content type belongs
# ============================================
locations:
  # Core content types - single canonical location
  decisions:
    file: .harness/decision-log.md
    format: "## Decision #N"
    description: "All decisions go here, not separate files"

  lessons:
    file: .harness/lessons-learned.md
    format: "## Lesson #N"
    description: "Failures and learnings"

  tasks:
    file: .harness/project-state.yaml
    section: next_session_actions
    format: '"P[0-2]:'
    description: "All task items in one place"

  ideas:
    file: .harness/ideas.yaml
    description: "Captured ideas with lifecycle"

  questions:
    file: .harness/questions.yaml
    description: "Open questions awaiting exploration"

  patterns:
    file: .harness/patterns-and-ideas.md
    format: "## "
    description: "Discovered patterns"

  session_summaries:
    file: .harness/project-state.yaml
    section: sessions
    description: "Session history"

  # Directory-based content types
  research:
    directory: .harness/research/
    register_in: PROJECT-MAP.md
    description: "Each research topic gets own file"

  transcripts:
    directory: .harness/transcripts/
    auto_generated: true
    register_in: null
    description: "Auto-generated, no registration required"

  atoms:
    file: .harness/atoms.jsonl
    description: "Extracted knowledge atoms"

  skills:
    directory: .claude/skills/
    register_in: null
    description: "Skills are self-describing via SKILL.md"

# ============================================
# REGISTRATION REQUIREMENTS (D17)
# What must be in PROJECT-MAP.md for discoverability
# ============================================
registration:
  index_file: .harness/PROJECT-MAP.md

  # These file patterns MUST be registered
  required_for:
    - .harness/*.md
    - .harness/*.yaml
    - 00-governance/*.md

  # These are excluded from registration requirement
  excludes:
    - .harness/transcripts/*
    - .harness/scripts/*
    - .harness/hooks/*
    - .harness/templates/*
    - .harness/reference/*
    - .harness/emergency-captures/*

# ============================================
# VALIDATION SETTINGS
# ============================================
validation:
  # Warn if .harness/ files aren't registered anywhere
  warn_unregistered: true

  # Directories to scan for unregistered files
  scan_directories:
    - .harness/
    - 00-governance/

  # File patterns to ignore in unregistered check
  ignore_patterns:
    - "*.pyc"
    - "__pycache__"
    - ".DS_Store"
    - "*.log"
    - "*.json"  # State files like recovery-state.json (gitignored)

# ============================================
# DOCUMENT METADATA REQUIREMENTS (D18)
# Every document should declare these properties
# ============================================
metadata_schema:
  required_fields:
    purpose:
      description: "One sentence job description for this document"
      example: "Track all architectural and process decisions with rationale"
    audience:
      description: "Who consumes this document"
      values: ["human", "llm", "both"]
      example: "llm"
    source_of_truth:
      description: "Is this authoritative or derived from other sources?"
      values: ["authoritative", "derived"]
      example: "authoritative"

# Document metadata registry
# Add new documents here with their metadata
document_metadata:
  CLAUDE.md:
    purpose: "Always-loaded project context, core principles, and operational instructions"
    audience: llm
    source_of_truth: authoritative

  .harness/decision-log.md:
    purpose: "Complete history of all decisions with rationale"
    audience: llm
    source_of_truth: authoritative

  .harness/project-state.yaml:
    purpose: "Current project phase, focus, blockers, and session history"
    audience: llm
    source_of_truth: authoritative

  .harness/lessons-learned.md:
    purpose: "Documented failures and learnings to prevent repetition"
    audience: both
    source_of_truth: authoritative

  .harness/PROJECT-MAP.md:
    purpose: "Navigation index for project structure and file locations"
    audience: llm
    source_of_truth: authoritative

  .harness/patterns-and-ideas.md:
    purpose: "Discovered patterns and emerging ideas"
    audience: both
    source_of_truth: authoritative

  .harness/atoms.jsonl:
    purpose: "Extracted knowledge atoms from session transcripts"
    audience: llm
    source_of_truth: authoritative

  00-governance/working-agreement.md:
    purpose: "Process agreements and operational protocols"
    audience: both
    source_of_truth: authoritative

  00-governance/capture-protocol.md:
    purpose: "End-of-session checklist and capture methodology"
    audience: both
    source_of_truth: authoritative

  00-governance/document-index.md:
    purpose: "Index of document purposes and single-source-of-truth rules"
    audience: both
    source_of_truth: authoritative
